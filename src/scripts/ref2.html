<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
    <script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
    <script src="https://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
    <script type = "text/javascript">

    var refTopic = "/js_ref";
    var websocketAddr = "ws://127.0.0.1:8000"
    var RosAddr = " ws://0.0.0.0:9090"
    var ros = new ROSLIB.Ros({
        url : RosAddr
    });
    ros.on('connection', function(){
        document.getElementById("status").innerHTML = "Connected";
        document.getElementById("action").innerHTML = "Connection to ROS established"
    });
    ros.on('error', function(error){
        document.getElementById("status").innerHTML = "Error:";
        document.getElementById("action").innerHTML = "Error with ROS connection."
    });
    ros.on('close', function() {
        document.getElementById("action").innerHTML = "Closed connection to ROS."
        document.getElementById("status").innerHTML = "Closed";
     });

    var refTopic = new ROSLIB.Topic({
      ros: ros,
      name: refTopic,
      messageType: 'std_msgs/String'
    });

    var websocket = new WebSocket(websocketAddr);
    websocket.onopen = function(e) {
        document.getElementById("action").innerHTML = 'Websocket connection open'
    };
    websocket.onerror = function(e) {
        document.getElementById("action").innerHTML = 'Websocket error'
    };
    websocket.onclose = function(e) {
        document.getElementById("action").innerHTML = 'Websocket closed'
    }
    websocket.addEventListener('Message', function(e) {
        document.getElementById("action").innerHTML = 'New websocket message'
        onMessage(e.data)
    });

    function onMessage(e) {
        let jsString = JSON.stringify(e);
        pubRos(jsString);
    }

    function pubRos(e) {
        let RefMessage = new ROSLIB.Message({
            data : e
        });
        refTopic.publish(RefMessage);
        document.getElementById("action").innerHTML = "Published message";
        document.getElementById("msg").innerHTML = e.data;
    }
    function resumeButtonFunction(e) {
        document.getElementById("action").innerHTML = "Resume button pressed";
        let RefMessage = new ROSLIB.Message({
            data: "{'signal':'start','targets':['Lebot'],'baskets':['magenta']}"
         });
        refTopic.publish(RefMessage);
        document.getElementById("msg").innerHTML = "{'signal':'start','targets':['Lebot'],'baskets':['magenta']}";
    }
    function pauseButtonFunction(e) {
        document.getElementById("action").innerHTML = "Pause button pressed";
        let RefMessage = new ROSLIB.Message({
            data: "{'signal':'stop','targets':['Lebot']}"
         });
        refTopic.publish(RefMessage);
        document.getElementById("msg").innerHTML = "{'signal':'stop','targets':['Lebot']}";
    }
</script>
</head>

<body>
  <h1>Lebot</h1>
  <p>Ros connection status: <span id="status"></span></p>
  <p>Last messaged published: <span id="msg"></span></p>
  <p>Latest action: <span id="action"></span></p>
  <p>Websocket status: <span id="ws_status"></span></p>
  <p><button id="resumeButton" type="button" onclick="resumeButtonFunction()">Resume</button></p>
  <p><button id="pauseButton" type="button" onclick="pauseButtonFunction()">Pause</button></p>
</body>
</html>
